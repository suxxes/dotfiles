# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# Secrets auto-loader

# {{ if eq .osType "darwin" -}}
# macOS: Load directly from 1Password on demand
function __load_op_secrets
    if not command -q op
        return
    end

    # Determine vaults (macOS uses Secrets + Secrets: Personal by default)
    set -l vaults "Secrets" "Secrets: Personal"

    # Get all items from configured vaults
    set -l all_items "[]"
    for vault in $vaults
        set -l vault_items (op item list --vault $vault --format json 2>/dev/null || echo "[]")
        set all_items (echo $all_items $vault_items | jq -s 'add | unique_by(.id)')
    end

    set -l items (echo $all_items | jq -r '.[].title' 2>/dev/null)

    for title in $items
        # Skip service account and LXC-specific items
        if string match -q "Service Account Token" $title
            continue
        end

        if string match -q "LXC:*" $title
            continue
        end

        # Get fields and export
        op item get $title --format json 2>/dev/null | \
            jq -r '.fields[]? | select(.value != null and .value != "") | select(.id != "notesPlain") | "\(.label)\t\(.value)"' 2>/dev/null | \
            while read -l key value
                set -l clean_key (string upper $key | string replace -a ' ' '_' | string replace -a '-' '_')
                set -gx $clean_key $value
            end
    end
end

# Load on shell start (cached for session)
if status is-interactive
    __load_op_secrets
end

# {{ else -}}
# Linux: Load OP service account token and generated secrets
if test -f ~/.config/op/service-account-token
    set -gx OP_SERVICE_ACCOUNT_TOKEN (cat ~/.config/op/service-account-token | string trim)
end

if test -f ~/.config/secrets/env.fish
    source ~/.config/secrets/env.fish
end
# {{ end }}
