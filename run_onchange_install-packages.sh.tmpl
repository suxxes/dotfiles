#!/bin/bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# Runs when template hash changes

set -e

# {{ if eq .osType "darwin" }}
echo "==> macOS: Installing packages via Homebrew"

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "==> Installing Homebrew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

brew install fish tmux mise mc htop git curl fzf bat git-delta lazygit tailscale

# {{ else }}
echo "==> Linux: Installing packages"
sudo apt update
sudo apt install -y fish tmux mc htop git curl unzip fontconfig fzf git-lfs

# fastfetch
if ! command -v fastfetch &> /dev/null; then
    sudo add-apt-repository -y ppa:zhangsongcui3371/fastfetch
    sudo apt update
    sudo apt install -y fastfetch
fi

# bat
if ! command -v bat &> /dev/null; then
    echo "==> Installing bat"
    BAT_VERSION=$(curl -s "https://api.github.com/repos/sharkdp/bat/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -fsSL "https://github.com/sharkdp/bat/releases/download/v${BAT_VERSION}/bat_${BAT_VERSION}_amd64.deb" -o /tmp/bat.deb
    sudo dpkg -i /tmp/bat.deb
    rm /tmp/bat.deb
fi

# git-delta
if ! command -v delta &> /dev/null; then
    echo "==> Installing git-delta"
    DELTA_VERSION=$(curl -s "https://api.github.com/repos/dandavison/delta/releases/latest" | grep -Po '"tag_name": "\K[^"]*')
    curl -fsSL "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/git-delta_${DELTA_VERSION}_amd64.deb" -o /tmp/delta.deb
    sudo dpkg -i /tmp/delta.deb
    rm /tmp/delta.deb
fi

# lazygit
if ! command -v lazygit &> /dev/null; then
    echo "==> Installing lazygit"
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -fsSL "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_linux_x86_64.tar.gz" -o /tmp/lazygit.tar.gz
    tar -C /tmp -xzf /tmp/lazygit.tar.gz lazygit
    sudo install /tmp/lazygit /usr/local/bin
    rm /tmp/lazygit.tar.gz /tmp/lazygit
fi

# mise
if ! command -v mise &> /dev/null; then
    curl https://mise.run | sh
    export PATH="$HOME/.local/bin:$PATH"
fi

# tailscale
if ! command -v tailscale &> /dev/null; then
    echo "==> Installing Tailscale"
    curl -fsSL https://tailscale.com/install.sh | sh
fi
# {{ end }}

# Install Oh My Fish
if [ ! -d "$HOME/.local/share/omf" ]; then
    echo "==> Installing Oh My Fish"
    curl https://raw.githubusercontent.com/oh-my-fish/oh-my-fish/master/bin/install | fish --command 'source - --noninteractive --yes'
fi

# Install Claude Code
if ! command -v claude &> /dev/null; then
    echo "==> Installing Claude Code"
    curl -fsLS https://claude.ai/install.sh | bash
fi

# Install Codex CLI
if ! command -v codex &> /dev/null; then
    echo "==> Installing Codex CLI"
    # {{ if eq .osType "darwin" }}
    brew install --cask codex
    # {{ else }}
    CODEX_VERSION=$(curl -s "https://api.github.com/repos/openai/codex/releases/latest" | grep -Po '"tag_name": "rust-v\K[^"]*')
    if [ -z "$CODEX_VERSION" ]; then
        echo "WARNING: Could not determine latest Codex version; skipping install"
    else
        CODEX_ARCHIVE=""
        case "$(uname -m)" in
            x86_64)
                CODEX_ARCHIVE="codex-x86_64-unknown-linux-musl.tar.gz"
                ;;
            aarch64|arm64)
                CODEX_ARCHIVE="codex-aarch64-unknown-linux-musl.tar.gz"
                ;;
            *)
                echo "WARNING: Unsupported architecture for Codex CLI install: $(uname -m)"
                ;;
        esac

        if [ -n "$CODEX_ARCHIVE" ]; then
            CODEX_BIN="${CODEX_ARCHIVE%.tar.gz}"
            curl -fsSL "https://github.com/openai/codex/releases/download/rust-v${CODEX_VERSION}/${CODEX_ARCHIVE}" -o "/tmp/${CODEX_ARCHIVE}"
            tar -C /tmp -xzf "/tmp/${CODEX_ARCHIVE}" "${CODEX_BIN}"
            sudo install "/tmp/${CODEX_BIN}" /usr/local/bin/codex
            rm -f "/tmp/${CODEX_ARCHIVE}" "/tmp/${CODEX_BIN}"
        fi
    fi
    # {{ end }}
fi

# Note: Claude credentials sync is handled by bind mount in cloud-init
# See cloud-init.vendor-data in LXD profile for automatic setup

# Authenticate Tailscale
if command -v tailscale &> /dev/null && ! tailscale status &> /dev/null; then
    echo "==> Authenticating Tailscale"

    # Load service account token if not already set
    if [ -z "$OP_SERVICE_ACCOUNT_TOKEN" ] && [ -f "$HOME/.config/op/service-account-token" ]; then
        export OP_SERVICE_ACCOUNT_TOKEN=$(cat "$HOME/.config/op/service-account-token" | tr -d '[:space:]')
    fi

    # Determine vaults based on profile type
    PROFILE_TYPE_FILE="/.profile"
    if [ -f "$PROFILE_TYPE_FILE" ]; then
        TS_PROFILE_TYPE=$(cat "$PROFILE_TYPE_FILE" | tr -d '[:space:]')
    else
        TS_PROFILE_TYPE="default"
    fi

    if [ "$TS_PROFILE_TYPE" = "work" ]; then
        TS_VAULTS=("Secrets" "Secrets: Work")
    elif [ "$TS_PROFILE_TYPE" = "personal" ]; then
        TS_VAULTS=("Secrets" "Secrets: Personal")
    else
        TS_VAULTS=("Secrets")
    fi

    TS_AUTHKEY=""
    for VAULT in "${TS_VAULTS[@]}"; do
        TS_AUTHKEY=$(op read "op://$VAULT/Tailscale/Auth Key" 2>/dev/null || echo "")
        [ -n "$TS_AUTHKEY" ] && break
    done

    if [ -n "$TS_AUTHKEY" ]; then
        sudo tailscale up --authkey="$TS_AUTHKEY" --advertise-tags=tag:lxc
        echo "Tailscale authenticated successfully"
    else
        echo "WARNING: Could not fetch Tailscale auth key from 1Password"
    fi
fi

# Install AWS CLI v2
if ! command -v aws &> /dev/null; then
    echo "==> Installing AWS CLI v2"
# {{ if eq .osType "darwin" }}
    brew install awscli
# {{ else }}
    curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
    unzip -q /tmp/awscliv2.zip -d /tmp
    sudo /tmp/aws/install
    rm -rf /tmp/awscliv2.zip /tmp/aws
# {{ end }}
fi
