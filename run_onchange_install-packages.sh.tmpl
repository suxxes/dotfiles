#!/bin/bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# Runs when template hash changes

set -e

# {{ if eq .osType "darwin" }}
echo "==> macOS: Installing packages via Homebrew"

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "==> Installing Homebrew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

brew install fish tmux mise mc htop git curl fzf

# {{ else }}
echo "==> Linux: Installing packages"
sudo apt update
sudo apt install -y fish tmux mc htop git curl unzip fontconfig fzf git-lfs

# fastfetch
if ! command -v fastfetch &> /dev/null; then
    sudo add-apt-repository -y ppa:zhangsongcui3371/fastfetch
    sudo apt update
    sudo apt install -y fastfetch
fi

# mise
if ! command -v mise &> /dev/null; then
    curl https://mise.run | sh
    export PATH="$HOME/.local/bin:$PATH"

    mise install python@3.13
    mise install node@24
fi
# {{ end }}

# Install Oh My Fish
if [ ! -d "$HOME/.local/share/omf" ]; then
    echo "==> Installing Oh My Fish"
    curl https://raw.githubusercontent.com/oh-my-fish/oh-my-fish/master/bin/install | fish --command 'source - --noninteractive --yes'
fi

# Install OMF plugins and theme
echo "==> Installing OMF plugins"
fish -c '
    set -l installed (omf list | string trim)

    for plugin in bass foreign-env fzf
        if not string match -q "*$plugin*" "$installed"
            omf install $plugin
        end
    end

    if not string match -q "*bobthefish*" "$installed"
        omf install bobthefish
        omf theme bobthefish
    end
'

# Install Claude Code
if ! command -v claude &> /dev/null; then
    echo "==> Installing Claude Code"
    curl -fsLS https://claude.ai/install.sh | bash
fi

# Set up Claude credentials symlink if shared storage exists
if [ -d "/mnt/claude-credentials" ]; then
    echo "==> Setting up Claude credentials sync"
    mkdir -p "$HOME/.claude"
    mkdir -p "/mnt/claude-credentials/.claude"
    rm -f "$HOME/.claude/.credentials.json"
    ln -sf /mnt/claude-credentials/.claude/.credentials.json "$HOME/.claude/.credentials.json"
fi

# Install AWS CLI v2
if ! command -v aws &> /dev/null; then
    echo "==> Installing AWS CLI v2"
# {{ if eq .osType "darwin" }}
    brew install awscli
# {{ else }}
    curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
    unzip -q /tmp/awscliv2.zip -d /tmp
    sudo /tmp/aws/install
    rm -rf /tmp/awscliv2.zip /tmp/aws
# {{ end }}
fi
