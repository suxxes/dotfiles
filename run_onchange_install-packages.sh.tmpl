#!/bin/bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# Runs when template hash changes

set -e

# {{ if eq .osType "darwin" }}
echo "==> macOS: Installing packages via Homebrew"

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "==> Installing Homebrew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

brew install fish tmux mise mc htop git curl fzf bat git-delta lazygit

# {{ else }}
echo "==> Linux: Installing packages"
sudo apt update
sudo apt install -y fish tmux mc htop git curl unzip fontconfig fzf git-lfs

# fastfetch
if ! command -v fastfetch &> /dev/null; then
    sudo add-apt-repository -y ppa:zhangsongcui3371/fastfetch
    sudo apt update
    sudo apt install -y fastfetch
fi

# bat
if ! command -v bat &> /dev/null; then
    echo "==> Installing bat"
    BAT_VERSION=$(curl -s "https://api.github.com/repos/sharkdp/bat/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -fsSL "https://github.com/sharkdp/bat/releases/download/v${BAT_VERSION}/bat_${BAT_VERSION}_amd64.deb" -o /tmp/bat.deb
    sudo dpkg -i /tmp/bat.deb
    rm /tmp/bat.deb
fi

# git-delta
if ! command -v delta &> /dev/null; then
    echo "==> Installing git-delta"
    DELTA_VERSION=$(curl -s "https://api.github.com/repos/dandavison/delta/releases/latest" | grep -Po '"tag_name": "\K[^"]*')
    curl -fsSL "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/git-delta_${DELTA_VERSION}_amd64.deb" -o /tmp/delta.deb
    sudo dpkg -i /tmp/delta.deb
    rm /tmp/delta.deb
fi

# lazygit
if ! command -v lazygit &> /dev/null; then
    echo "==> Installing lazygit"
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -fsSL "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_linux_x86_64.tar.gz" -o /tmp/lazygit.tar.gz
    tar -C /tmp -xzf /tmp/lazygit.tar.gz lazygit
    sudo install /tmp/lazygit /usr/local/bin
    rm /tmp/lazygit.tar.gz /tmp/lazygit
fi

# mise
if ! command -v mise &> /dev/null; then
    curl https://mise.run | sh
    export PATH="$HOME/.local/bin:$PATH"

    mise install python@3.13
    mise install node@24
fi
# {{ end }}

# Install Oh My Fish
if [ ! -d "$HOME/.local/share/omf" ]; then
    echo "==> Installing Oh My Fish"
    curl https://raw.githubusercontent.com/oh-my-fish/oh-my-fish/master/bin/install | fish --command 'source - --noninteractive --yes'
fi

# Install Claude Code
if ! command -v claude &> /dev/null; then
    echo "==> Installing Claude Code"
    curl -fsLS https://claude.ai/install.sh | bash
fi

# Note: Claude credentials sync is handled by bind mount in cloud-init
# See cloud-init.vendor-data in LXD profile for automatic setup

# Install AWS CLI v2
if ! command -v aws &> /dev/null; then
    echo "==> Installing AWS CLI v2"
# {{ if eq .osType "darwin" }}
    brew install awscli
# {{ else }}
    curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
    unzip -q /tmp/awscliv2.zip -d /tmp
    sudo /tmp/aws/install
    rm -rf /tmp/awscliv2.zip /tmp/aws
# {{ end }}
fi
