#!/bin/bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# Generates ~/.config/secrets/env.fish from 1Password items
# Hash: # {{ include "dot_config/fish/conf.d/50-secrets.fish.tmpl" | sha256sum }}

set -e

# {{ if eq .machineType "mac" }}
# Mac: secrets loaded directly in fish, skip generation
exit 0
# {{ end }}

SECRETS_DIR="$HOME/.config/secrets"
SECRETS_FILE="$SECRETS_DIR/env.fish"
HOSTNAME=$(hostname)

mkdir -p "$SECRETS_DIR"

echo "# Auto-generated by chezmoi - do not edit" > "$SECRETS_FILE"
echo "# Generated: $(date -Iseconds)" >> "$SECRETS_FILE"
echo "" >> "$SECRETS_FILE"

# Check if op is available and authenticated
if ! command -v op &> /dev/null; then
    echo "# ERROR: 1Password CLI not installed" >> "$SECRETS_FILE"
    exit 0
fi

if ! op account list &> /dev/null; then
    echo "# ERROR: Not authenticated to 1Password" >> "$SECRETS_FILE"
    exit 0
fi

# Get all items from Secrets vault
ITEMS=$(op item list --vault Secrets --format json 2>/dev/null || echo "[]")

if [ "$ITEMS" = "[]" ]; then
    echo "# WARNING: No items found in Secrets vault" >> "$SECRETS_FILE"
    exit 0
fi

# Process each item
echo "$ITEMS" | jq -r '.[] | .title' | while read -r TITLE; do
    # Skip Service Account Token
    if [[ "$TITLE" == "Service Account Token" ]]; then
        continue
    fi

    # Skip LXC items not matching this hostname
    if [[ "$TITLE" == LXC:* ]]; then
        ITEM_HOST=$(echo "$TITLE" | sed 's/^LXC: *//')
        if [[ "$ITEM_HOST" != "$HOSTNAME" ]]; then
            continue
        fi
        echo "# From: $TITLE (container-specific)" >> "$SECRETS_FILE"
    else
        echo "# From: $TITLE" >> "$SECRETS_FILE"
    fi

    # Get all fields from this item
    FIELDS=$(op item get "$TITLE" --vault Secrets --format json 2>/dev/null | \
        jq -r '.fields[]? | select(.value != null and .value != "") | select(.id != "notesPlain") | "\(.label)=\(.value)"' 2>/dev/null || echo "")

    while IFS='=' read -r KEY VALUE; do
        if [ -n "$KEY" ] && [ -n "$VALUE" ]; then
            # Sanitize key: uppercase, replace spaces/dashes with underscore
            CLEAN_KEY=$(echo "$KEY" | tr '[:lower:]' '[:upper:]' | tr ' -' '_' | tr -cd '[:alnum:]_')
            echo "set -gx $CLEAN_KEY \"$VALUE\"" >> "$SECRETS_FILE"
        fi
    done <<< "$FIELDS"

    echo "" >> "$SECRETS_FILE"
done

chmod 600 "$SECRETS_FILE"
echo "Generated secrets file: $SECRETS_FILE"
