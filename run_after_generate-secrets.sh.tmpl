#!/bin/bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# Generates ~/.config/secrets/env.fish from 1Password Secrets vault
# Fetches: all items NOT matching "LXC: ..." + items matching "LXC: <hostname>"
# Hash: # {{ include "dot_config/fish/conf.d/50-secrets.fish.tmpl" | sha256sum }}

set -e

# {{ if eq .osType "darwin" }}
# macOS: secrets loaded directly in fish, skip generation
exit 0
# {{ end }}

SECRETS_DIR="$HOME/.config/secrets"
SECRETS_FILE="$SECRETS_DIR/env.fish"
HOSTNAME=$(hostname)

# Determine vaults based on profile type
PROFILE_TYPE_FILE="$HOME/.config/profile-type"
if [ -f "$PROFILE_TYPE_FILE" ]; then
    PROFILE_TYPE=$(cat "$PROFILE_TYPE_FILE" | tr -d '[:space:]')
else
    PROFILE_TYPE="default"
fi

# Set vaults: always include "Secrets", plus profile-specific vault
if [ "$PROFILE_TYPE" = "work" ]; then
    VAULTS=("Secrets" "Secrets: Work")
elif [ "$PROFILE_TYPE" = "personal" ]; then
    VAULTS=("Secrets" "Secrets: Personal")
else
    VAULTS=("Secrets")
fi

mkdir -p "$SECRETS_DIR"

echo "# Auto-generated by chezmoi - do not edit" > "$SECRETS_FILE"
echo "# Generated: $(date -Iseconds)" >> "$SECRETS_FILE"
echo "# Hostname: $HOSTNAME" >> "$SECRETS_FILE"
echo "# Profile: $PROFILE_TYPE" >> "$SECRETS_FILE"
echo "# Vaults: ${VAULTS[*]}" >> "$SECRETS_FILE"
echo "" >> "$SECRETS_FILE"

# Check if op is available and authenticated
if ! command -v op &> /dev/null; then
    echo "# ERROR: 1Password CLI not installed" >> "$SECRETS_FILE"
    exit 0
fi

if ! op account list &> /dev/null; then
    echo "# ERROR: Not authenticated to 1Password" >> "$SECRETS_FILE"
    exit 0
fi

# Get all items from configured vaults
ITEMS="[]"
for VAULT in "${VAULTS[@]}"; do
    VAULT_ITEMS=$(op item list --vault "$VAULT" --format json 2>/dev/null || echo "[]")
    ITEMS=$(echo "$ITEMS" "$VAULT_ITEMS" | jq -s 'add | unique_by(.id)')
done

if [ "$ITEMS" = "[]" ]; then
    echo "# WARNING: No items found in configured vaults" >> "$SECRETS_FILE"
    exit 0
fi

# Process each item
echo "$ITEMS" | jq -r '.[] | "\(.title)|\(.vault.id)"' | while IFS='|' read -r TITLE VAULT_ID; do
    # Skip Service Account Token, LXC SSH Key, and AWS SSO profiles
    if [[ "$TITLE" == "Service Account Token" ]] || [[ "$TITLE" == "LXC SSH Key" ]] || [[ "$TITLE" == "AWS SSO:"* ]]; then
        continue
    fi

    # Handle LXC-specific items
    if [[ "$TITLE" == LXC:* ]]; then
        # Extract hostname from "LXC: hostname" or "LXC:hostname"
        ITEM_HOST=$(echo "$TITLE" | sed 's/^LXC: *//')
        if [[ "$ITEM_HOST" != "$HOSTNAME" ]]; then
            continue
        fi
        echo "# From: $TITLE (container-specific)" >> "$SECRETS_FILE"
    else
        # Include all non-LXC items (shared secrets)
        echo "# From: $TITLE" >> "$SECRETS_FILE"
    fi

    # Get all fields from this item (excluding notes)
    FIELDS=$(op item get "$TITLE" --format json 2>/dev/null | \
        jq -r '.fields[]? | select(.value != null and .value != "") | select(.id != "notesPlain") | "\(.label)=\(.value)"' 2>/dev/null || echo "")

    while IFS='=' read -r KEY VALUE; do
        if [ -n "$KEY" ] && [ -n "$VALUE" ]; then
            # Sanitize key: uppercase, replace spaces/dashes with underscore
            CLEAN_KEY=$(echo "$KEY" | tr '[:lower:]' '[:upper:]' | tr ' -' '_' | tr -cd '[:alnum:]_')
            # Escape double quotes in value
            ESCAPED_VALUE=$(echo "$VALUE" | sed 's/"/\\"/g')
            echo "set -gx $CLEAN_KEY \"$ESCAPED_VALUE\"" >> "$SECRETS_FILE"
        fi
    done <<< "$FIELDS"

    echo "" >> "$SECRETS_FILE"
done

chmod 600 "$SECRETS_FILE"
echo "Generated secrets file: $SECRETS_FILE"

# Generate AWS SSO config from 1Password
AWS_DIR="$HOME/.aws"
AWS_CONFIG="$AWS_DIR/config"

mkdir -p "$AWS_DIR"
chmod 700 "$AWS_DIR"

echo "# Auto-generated by chezmoi - do not edit" > "$AWS_CONFIG"
echo "# Generated: $(date -Iseconds)" >> "$AWS_CONFIG"
echo "" >> "$AWS_CONFIG"

# Process AWS SSO items
echo "$ITEMS" | jq -r '.[] | .title' | while read -r TITLE; do
    if [[ "$TITLE" != "AWS SSO:"* ]]; then
        continue
    fi

    # Extract profile name from "AWS SSO: profile_name"
    PROFILE_NAME=$(echo "$TITLE" | sed 's/^AWS SSO: *//')

    echo "[profile $PROFILE_NAME]" >> "$AWS_CONFIG"

    # Get all fields from this item
    op item get "$TITLE" --format json 2>/dev/null | \
        jq -r '.fields[]? | select(.value != null and .value != "") | select(.id != "notesPlain") | "\(.label)=\(.value)"' 2>/dev/null | \
        while IFS='=' read -r KEY VALUE; do
            if [ -n "$KEY" ] && [ -n "$VALUE" ]; then
                # Convert key to lowercase with underscores
                CLEAN_KEY=$(echo "$KEY" | tr '[:upper:]' '[:lower:]' | tr ' -' '_')
                echo "$CLEAN_KEY = $VALUE" >> "$AWS_CONFIG"
            fi
        done

    echo "" >> "$AWS_CONFIG"
done

chmod 600 "$AWS_CONFIG"
echo "Generated AWS config: $AWS_CONFIG"

# Setup SSH key for git operations
SSH_DIR="$HOME/.ssh"
SSH_KEY="$SSH_DIR/id_ed25519"

mkdir -p "$SSH_DIR"
chmod 700 "$SSH_DIR"

# Fetch private key from 1Password (try all vaults)
PRIVATE_KEY=""
for VAULT in "${VAULTS[@]}"; do
    PRIVATE_KEY=$(op read "op://$VAULT/LXC SSH Key/private key" 2>/dev/null || echo "")
    [ -n "$PRIVATE_KEY" ] && break
done

if [ -n "$PRIVATE_KEY" ]; then
    echo "$PRIVATE_KEY" > "$SSH_KEY"
    chmod 600 "$SSH_KEY"

    # Fetch public key from the same vault
    PUBLIC_KEY=""
    for VAULT in "${VAULTS[@]}"; do
        PUBLIC_KEY=$(op read "op://$VAULT/LXC SSH Key/public key" 2>/dev/null || echo "")
        [ -n "$PUBLIC_KEY" ] && break
    done
    if [ -n "$PUBLIC_KEY" ]; then
        echo "$PUBLIC_KEY" > "$SSH_KEY.pub"
        chmod 644 "$SSH_KEY.pub"

        echo "$PUBLIC_KEY" > "$SSH_DIR/authorized_keys"
        chmod 600 "$SSH_DIR/authorized_keys"
        echo "Installed authorized_keys"
    fi
    echo "Installed SSH key: $SSH_KEY"
else
    echo "WARNING: Could not fetch SSH key from 1Password"
fi
